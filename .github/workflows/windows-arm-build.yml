name: Build Phrost Engine (Windows Arm64)

on:
  workflow_dispatch:
  push:
    branches: ["master"]
  pull_request:
    branches: ["master"]

jobs:
  build:
    name: Build on Windows 11 Arm64
    runs-on: windows-11-arm

    defaults:
      run:
        shell: powershell

    steps:
      # 1. Checkout code into a subdirectory 'Phrost'
      - name: Checkout Code
        uses: actions/checkout@v4
        with:
          path: Phrost

      # 2. Setup Directory Variables
      - name: Set Directory Vars
        run: |
          $ROOT_DIR = Get-Location
          echo "DEPS_DIR=$($ROOT_DIR)\deps" >> $env:GITHUB_ENV
          echo "REPO_DIR=$($ROOT_DIR)\Phrost" >> $env:GITHUB_ENV

      # 3. Install Swift 6.0 (Arm64)
      - name: Install Swift 6.0 (Arm64)
        run: |
          $SwiftUrl = "https://download.swift.org/swift-6.0.2-release/windows10/swift-6.0.2-RELEASE/swift-6.0.2-RELEASE-windows10-aarch64.exe"
          Write-Host "Downloading Swift installer from $SwiftUrl ..."

          # Use curl.exe (-L handles redirects, -o specifies output file)
          curl.exe -L -o "swift-installer.exe" $SwiftUrl

          Write-Host "Installing Swift..."
          Start-Process -FilePath ".\swift-installer.exe" -ArgumentList "/quiet /norestart" -Wait

          # Add Swift to Path
          echo "$env:SystemDrive\Library\Developer\Toolchains\unknown-Asserts-development.xctoolchain\usr\bin" >> $env:GITHUB_PATH

      # 4. Cache Dependencies
      - name: Cache Deps
        id: cache-deps
        uses: actions/cache@v3
        with:
          path: deps
          key: ${{ runner.os }}-arm64-deps-v2 # Incremented key to v2

      # 5. Setup Dependencies (Updated)
      - name: Download and Setup Dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: |
          # Ensure main deps folder exists
          New-Item -ItemType Directory -Path $env:DEPS_DIR -Force | Out-Null
          Set-Location $env:DEPS_DIR

          # --- A. PHP SDK (Placeholder - Adjust URL/Version as needed) ---
          $PHP_FOLDER_NAME = "php-8.4.10-nts-Win32-vs17-arm64"
          Write-Host "Downloading PHP SDK..."
          # NOTE: Using a generic QA link as placeholder. Ensure this matches your version.
          Invoke-WebRequest -Uri "https://windows.php.net/downloads/qa/$PHP_FOLDER_NAME.zip" -OutFile "php.zip"

          # Extract to a temp folder first to organize it like your script expects (SDK folder)
          Expand-Archive -Path "php.zip" -DestinationPath "php_temp" -Force

          # Structure adjustment: Create the specific folder name your script looks for
          $PHP_FINAL_DIR = Join-Path $env:DEPS_DIR $PHP_FOLDER_NAME
          New-Item -ItemType Directory -Path (Join-Path $PHP_FINAL_DIR "SDK") -Force | Out-Null

          # Move contents to SDK (standard PHP zips are flat, your script expects 'SDK\include')
          Move-Item -Path "php_temp\*" -Destination (Join-Path $PHP_FINAL_DIR "SDK") -Force
          Remove-Item "php_temp" -Recurse -Force

          # --- B. SDL3 ---
          Write-Host "Downloading SDL3..."
          Invoke-WebRequest -Uri "https://github.com/libsdl-org/SDL/releases/download/preview-3.1.3/SDL3-3.1.3-win32-arm64.zip" -OutFile "sdl3.zip"
          Expand-Archive -Path "sdl3.zip" -DestinationPath "SDL3-arm64" -Force

          # --- C. Chipmunk2D (UPDATED) ---
          Write-Host "Downloading Chipmunk2D..."
          $ChipmunkUrl = "https://github.com/joseph-montanez/Phrost/releases/download/v0.01/chipmunk_arm64-windows.zip"

          # Your script looks in: ..\..\deps\vcpkg\packages\chipmunk_arm64-windows
          # So we must create the parent folders first
          $VcpkgPackagesDir = Join-Path $env:DEPS_DIR "vcpkg\packages"
          New-Item -ItemType Directory -Path $VcpkgPackagesDir -Force | Out-Null

          Invoke-WebRequest -Uri $ChipmunkUrl -OutFile "chipmunk.zip"

          # Extract into 'packages'.
          # Because the zip ROOT is 'chipmunk_arm64-windows', it will create the correct directory structure automatically.
          Expand-Archive -Path "chipmunk.zip" -DestinationPath $VcpkgPackagesDir -Force

          Write-Host "Dependencies setup complete."

      # 6. Run Build Script
      - name: Run Build Script
        run: |
          $ScriptPath = Join-Path $env:REPO_DIR "Engine\PhrostEngineV2\scripts\build.ps1"
          Write-Host "Running build script at: $ScriptPath"
          & $ScriptPath

      # 7. Upload Artifacts
      - name: Upload Release
        uses: actions/upload-artifact@v4
        with:
          name: Phrost-Windows-Arm64
          path: Phrost/Release
